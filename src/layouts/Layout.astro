---
import Footer from '../components/Footer.astro';
import { SITE_NAME } from '../consts';
import Analytics from '@vercel/analytics/astro';
interface Props {
	title: string;
}

const { title } = Astro.props;
const navLinks = { 
	"/":"Home",
	"/blog":"Blog",
	"/about":"About"
}
const gaMeasurementIdExists = !!import.meta.env.PUBLIC_GA_MEASUREMENT_ID;
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="Astro description" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve" height="100px" width="100px"><text y=".9em" font-size="90">0️⃣</text></svg>' />
		<meta name="generator" content={Astro.generator} />
		<title>{title || SITE_NAME}</title>
		{/* Google Analytics 4 (GA4) */}
		{gaMeasurementIdExists && (
			<>
				<script is:inline async src={`https://www.googletagmanager.com/gtag/js?id=${import.meta.env.GA_MEASUREMENT_ID}`}></script>
				<script is:inline>
				  window.dataLayer = window.dataLayer || [];
				  function gtag(){dataLayer.push(arguments);}
				  gtag('js', new Date());
				  gtag('config', '${import.meta.env.PUBLIC_GA_MEASUREMENT_ID}');
				</script>
			</>
		)}
		{/* End Google Analytics 4 */}
	</head>
	<body>
		<nav class="border-b-1 border-b-gray-200">
			<div class="flex items-center justify-between border-x-1 border-gray-200 pl-5 wrapper mx-auto">
					<a href="/" class="flex items-center py-2">
					<h1 class="font-mono text-lg sm:text-xl text-gray-900 dark:text-gray-100">NOTSHORT</h1>
				</a>
				<div class="flex items-center">
					<ul class={`grid grid-auto-flow-col`}>
						{Object.entries(navLinks).map(([href, title]) => {
							return <li class="grid-col-[span_1] block">
								<a href={href} class="text-sm px-5 py-8 tracking-0.1 block">{title}</a>
							</li>
						})}
					</ul>
					
				</div>
			</div>
		</nav>
		<main>
		<slot />
		</main>
		{/* Container for toast notifications, managed by toastService.ts */}
		<div id="toast-notifications-container" class="fixed top-0 right-0 z-50 p-4 space-y-2"></div>
		<Footer />
				<script>
			import { supabase } from '../lib/supabaseClient';
			
			// Desktop elements
			const loginLink = document.getElementById('login-link');
			const signupLink = document.getElementById('signup-link');
			const dashboardLink = document.getElementById('dashboard-link');
			const logoutBtn = document.getElementById('logout-btn');
			
			// Mobile elements
			const mobileLoginLink = document.getElementById('mobile-login-link');
			const mobileSignupLink = document.getElementById('mobile-signup-link');
			const mobileDashboardLink = document.getElementById('mobile-dashboard-link');
			const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
			
			// Mobile menu elements
			const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
			const mobileMenu = document.getElementById('mobile-menu');
			
			// Mobile menu toggle
			mobileMenuToggle?.addEventListener('click', () => {
				mobileMenu?.classList.toggle('hidden');
			});
			
			// Close mobile menu when clicking outside
			document.addEventListener('click', (event) => {
				const target = event.target as HTMLElement;
				if (mobileMenu && 
					!mobileMenu.classList.contains('hidden') && 
					!mobileMenu.contains(target) && 
					!mobileMenuToggle?.contains(target)) {
					mobileMenu.classList.add('hidden');
				}
			});
			
			// Check auth status and update UI
			async function updateAuthUI() {
				// First authenticate user securely through the Supabase Auth server
				const { data: userData } = await supabase.auth.getUser();
				// Then get the session if needed
				await supabase.auth.getSession(); // We don't need the session data, just the user data
				// Use authenticated user status as the source of truth
				const isLoggedIn = !!userData.user;
				
				if (isLoggedIn) {
					// User is logged in - Desktop
					loginLink?.classList.add('hidden');
					signupLink?.classList.add('hidden');
					dashboardLink?.classList.remove('hidden');
					logoutBtn?.classList.remove('hidden');
					
					// User is logged in - Mobile
					mobileLoginLink?.classList.add('hidden');
					mobileSignupLink?.classList.add('hidden');
					mobileDashboardLink?.classList.remove('hidden');
					mobileLogoutBtn?.classList.remove('hidden');
				} else {
					// User is not logged in - Desktop
					loginLink?.classList.remove('hidden');
					signupLink?.classList.remove('hidden');
					dashboardLink?.classList.add('hidden');
					logoutBtn?.classList.add('hidden');
					
					// User is not logged in - Mobile
					mobileLoginLink?.classList.remove('hidden');
					mobileSignupLink?.classList.remove('hidden');
					mobileDashboardLink?.classList.add('hidden');
					mobileLogoutBtn?.classList.add('hidden');
				}
			}
			
			// Handle logout - Desktop
			logoutBtn?.addEventListener('click', async () => {
				await supabase.auth.signOut();
				window.location.href = '/';
			});
			
			// Handle logout - Mobile
			mobileLogoutBtn?.addEventListener('click', async () => {
				await supabase.auth.signOut();
				window.location.href = '/';
			});
			
			// Initial auth UI update
			updateAuthUI();
		</script>
		<Analytics />
	</body>
</html>
<style is:global>
	html,
	body {
		height: 100%;
		min-height: 100vh;
	}
	body {
		display: flex;
		flex-flow: column;
	}
	body > main {
		flex: 1;
	}
	.content-wrapper {
        :is(h2,h3,h4,h5,h6) {
            font-weight: 600;
            margin-top: 1ex;
        }
        p {
            margin-top: 1ex;
        }
        h2 {
            font-size: 1.875rem;
        }
        h3 {
            font-size: 1.5rem;
        }
        h4 {
            font-size: 1.35rem;
        }
        h5, h6 {
            font-weight: 500;
            font-size: 1.1rem;
        }
		ul {
			list-style-type:square;
			list-style-position: inside;
			margin-top: 1ex;
		}
		pre {
			margin-top: 1ex;
			padding-block: 1.5rem;
		}
    }
</style>