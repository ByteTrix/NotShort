---
// LongifyForm.astro - Form component for "longifying" URLs
---

<div class="longify-form w-full max-w-3xl mx-auto">
  <form id="url-form" class="flex flex-col md:flex-row gap-4 w-full">
    <div class="flex-grow">
      <input 
        type="url" 
        id="original-url" 
        name="url" 
        placeholder="Enter a URL to make it unnecessarily long..." 
        required
        class="w-full px-4 py-3 border-1 border-gray-300 dark:border-gray-700 font-mono focus:ring-2 focus:ring-gray-400 focus:outline-none transition-colors"
      />
    </div>
    <button 
      type="submit" 
      class="longify-btn relative overflow-hidden fw-bold bg-gray-800 hover:bg-gray-700 c-gray-100 text-5 text-center py-3 px-7 md:w-auto transition-all duration-300 transform hover:scale-[1.02]"
    >
      <span class="relative z-10">Make It Long!</span>
      <span class="btn-bg absolute inset-0 w-full h-full transform scale-x-0 origin-left transition-transform duration-500"></span>
    </button>
  </form>
  
  <div id="result-container" class="mt-6 hidden">
    <div class="bg-gray-100 dark:bg-gray-800 border-1 border-gray-200 dark:border-gray-700 p-6 rounded-sm">
      <h3 class="font-mono text-lg mb-3">Your Unnecessarily Long URL:</h3>
      <div class="flex flex-col sm:flex-row gap-2 items-start sm:items-center">
        <div class="url-display max-w-full overflow-hidden font-mono text-sm bg-white dark:bg-gray-900 p-3 border-1 border-gray-200 dark:border-gray-700 flex-grow break-all">
          <span id="long-url">https://notshort.in/very-long-ridiculous-url-example</span>
        </div>
        <button 
          id="copy-btn" 
          class="py-2 px-4 bg-gray-800 hover:bg-gray-700 text-white font-mono text-sm transition-colors whitespace-nowrap"
        >
          Copy URL
        </button>
      </div>
      <p id="copy-confirmation" class="text-green-600 mt-2 text-sm hidden">
        Copied to clipboard!
      </p>
      <p class="text-xs text-gray-500 dark:text-gray-400 mt-4">
        We've added ~500% more characters to your URL. You're welcome!
      </p>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('url-form');
    const resultContainer = document.getElementById('result-container');
    const longUrlElement = document.getElementById('long-url');
    const copyBtn = document.getElementById('copy-btn');
    const copyConfirmation = document.getElementById('copy-confirmation');
    
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Get the URL from the form
      const urlInput = document.getElementById('original-url') as HTMLInputElement;
      const url = urlInput.value.trim();
      
      if (!url) return;
      
      try {
        // Call the longify API endpoint
        const response = await fetch('/api/longify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ url }),
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to create long URL');
        }
        
        const data = await response.json();
        
        // Display the result
        if (longUrlElement && resultContainer) {
          longUrlElement.textContent = data.long;
          longUrlElement.setAttribute('data-url', data.long);
          resultContainer.classList.remove('hidden');
          
          // Scroll to the result container
          resultContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      } catch (error: any) { // Type error as 'any' to access message property
        console.error('Error longifying URL:', error);
        alert(`Error: ${error.message || 'Failed to create long URL'}`);
      }
    });
    
    // Copy to clipboard functionality
    copyBtn?.addEventListener('click', async () => {
      const urlToCopy = longUrlElement?.getAttribute('data-url') || longUrlElement?.textContent;
      
      if (urlToCopy) {
        try {
          await navigator.clipboard.writeText(urlToCopy);
          
          // Show copy confirmation
          if (copyConfirmation) {
            copyConfirmation.classList.remove('hidden');
            setTimeout(() => {
              copyConfirmation.classList.add('hidden');
            }, 3000);
          }
        } catch (err) {
          console.error('Failed to copy URL:', err);
        }
      }
    });
  });
</script>

<style>
  .btn-bg {
    background: linear-gradient(90deg, #3B82F6 0%, #8B5CF6 100%);
  }
  
  .longify-btn:hover .btn-bg {
    transform: scale-x-100;
  }
</style>